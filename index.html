<html>
<head>
  <title>Social Network Multiplayer</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/websim-socket@1.2.0/dist/websim-socket.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
  <style>
    body {
      perspective: 1px;
      overflow-x: hidden;
      overflow-y: scroll;
      font-family: 'Segoe UI', system-ui, sans-serif;
      margin: 0;
      padding: 20px;
      color: #2a363f;
      min-height: 100vh;
      position: relative;
    }
    body:before {
      content: '';
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      pointer-events: none;
    }

    .parallax-background {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('/Novo Projeto (3).png') no-repeat center center;
      background-size: cover;
      transform: translateZ(-1px) scale(2);
      z-index: 0;
      will-change: transform;
    }

    .container {
      max-width: 100%;
      width: 90vw;
      transform: translateZ(0);
      position: relative;
      z-index: 1;
    }

    .post {
      width: 90%;
      max-width: 90vw;
      margin-left: auto;
      margin-right: auto;
      background: rgba(255, 255, 255, 0.7);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 30px;
      margin-bottom: 30px;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 8px 32px rgba(0, 91, 150, 0.2),
                  inset 0 0 12px rgba(255,255,255,0.4),
                  0 0 30px rgba(0, 150, 255, 0.3);
      position: relative;
      overflow: hidden;
      transition: box-shadow 0.3s ease;
    }

    .post:hover {
      box-shadow: 0 8px 40px rgba(0, 150, 255, 0.5),
                  inset 0 0 15px rgba(255,255,255,0.6),
                  0 0 40px rgba(0, 200, 255, 0.5);
    }

    .post:before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(45deg, 
        transparent 25%,
        rgba(255,255,255,0.3) 25%, 
        rgba(255,255,255,0.3) 50%,
        transparent 50%,
        transparent 75%,
        rgba(255,255,255,0.3) 75%);
      background-size: 4px 4px;
      opacity: 0.3; 
      transform: rotate(-5deg);
      animation: holograph 3s infinite;
    }

    @keyframes holograph {
      0% { transform: translateX(-50%) rotate(-5deg); }
      100% { transform: translateX(150%) rotate(-5deg); }
    }

    .post:after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border-radius: 16px;
      pointer-events: none;
      background: radial-gradient(
        600px circle at var(--x) var(--y),
        rgba(0, 180, 255, 0.15),
        transparent 40%
      );
      opacity: 0.6;
      z-index: -1;
    }

    .tab-button {
      background: linear-gradient(145deg, #00c8ff, #0099cc);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 20px;
      padding: 15px 25px;
      margin: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5),
                  0 4px 25px rgba(0, 150, 255, 0.4),
                  inset 0 0 15px rgba(255,255,255,0.5);
      position: relative;
      overflow: hidden;
    }

    .tab-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 230, 255, 0.8),
                  0 6px 35px rgba(0, 180, 255, 0.6),
                  inset 0 0 25px rgba(255,255,255,0.7),
                  0 0 40px rgba(0, 255, 255, 0.4);
      filter: brightness(1.1);
    }

    .online-users {
      background: rgba(255, 255, 255, 0.8);
      backdrop-filter: blur(8px);
      border: 1px solid rgba(255,255,255,0.5);
      box-shadow: 0 8px 32px rgba(0, 91, 150, 0.1);
    }

    img.avatar, video {
      border: 2px solid rgba(255,255,255,0.8);
      box-shadow: 0 0 8px rgba(0,150,255,0.3),
                  inset 0 0 8px rgba(255,255,255,0.3);
    }

    input, textarea, select {
      background: rgba(255,255,255,0.9) !important;
      border: 1px solid rgba(0,150,255,0.3) !important;
      border-radius: 12px !important;
      padding: 12px !important;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.1) !important;
    }

    .holographic-effect {
      position: relative;
      overflow: hidden;
    }

    .holographic-effect:after {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 200%;
      height: 100%;
      background: linear-gradient(90deg,
        transparent 25%,
        rgba(255,255,255,0.4) 50%,
        transparent 75%);
      animation: holograph 3s infinite;
    }

    @keyframes holograph {
      0% { transform: translateX(-50%); }
      100% { transform: translateX(150%); }
    }

    .bubble {
      position: fixed;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.8), transparent);
      border-radius: 50%;
      filter: blur(40px);
      opacity: 0.3;
      z-index: 0;
      transform: translateZ(-0.5px) scale(1.5);
    }
    
    .security-warning {
      background: #ffebee;
      border: 2px solid #ff1744;
      padding: 12px;
      border-radius: 8px;
      margin: 16px 0;
    }
    .frutiger-button {
      background: linear-gradient(145deg, #00c8ff, #0099cc);
      border: 2px solid rgba(255,255,255,0.5);
      border-radius: 20px;
      padding: 10px 15px;
      margin: 10px;
      color: white;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 20px rgba(0, 200, 255, 0.5),
                  0 4px 25px rgba(0, 150, 255, 0.4),
                  inset 0 0 15px rgba(255,255,255,0.5);
      position: relative;
      overflow: hidden;
    }

    .frutiger-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 0 30px rgba(0, 230, 255, 0.8),
                  0 6px 35px rgba(0, 180, 255, 0.6),
                  inset 0 0 25px rgba(255,255,255,0.7),
                  0 0 40px rgba(0, 255, 255, 0.4);
      filter: brightness(1.1);
    }

    .frutiger-button img {
      width: 24px;
      height: 24px;
      filter: drop-shadow(0 0 5px rgba(0, 255, 255, 0.7));
    }

    .guidelines-box {
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(8px);
      border-radius: 20px;
      padding: 15px;
      margin: 10px auto;
      max-width: 600px;
      border: 2px solid #00c8ff;
      box-shadow: 0 8px 32px rgba(0, 200, 255, 0.2);
    }

    .guidelines-box h3 {
      font-size: 1.1em;
      margin: 8px 0;
    }
    .guidelines-box h4 {
      font-size: 1em;
      margin: 6px 0;
    }
    .guidelines-box ol, .guidelines-box ul {
      padding-left: 20px;
      margin: 5px 0;
    }

    .frutiger-reaction-button {
      background: linear-gradient(145deg, #00c8ff, #0099cc);
      border: 2px solid rgba(255,255,255,0.5) !important;
      border-radius: 20px !important;
      padding: 8px 16px !important;
      color: white !important;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 0 15px rgba(0, 200, 255, 0.4),
                  inset 0 0 8px rgba(255,255,255,0.4),
                  0 0 20px rgba(0, 150, 255, 0.3);
      display: flex;
      align-items: center;
      gap: 6px;
      text-shadow: 0 0 5px rgba(0, 150, 255, 0.5);
    }

    .frutiger-reaction-button:hover {
      box-shadow: 0 0 25px rgba(0, 230, 255, 0.6),
                  inset 0 0 12px rgba(255,255,255,0.6),
                  0 0 30px rgba(0, 200, 255, 0.5);
      transform: translateY(-1px) scale(1.05);
      filter: brightness(1.1);
    }
    .top-right-logo {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 999;
      max-width: 200px;
      height: auto;
      mix-blend-mode: screen;
      filter: drop-shadow(0 0 15px rgba(0, 255, 255, 0.5));
      transition: all 0.3s ease;
    }

    .top-right-logo img {
      width: 100%;
      height: auto;
      object-fit: contain;
    }

    @media (max-width: 768px) {
      .top-right-logo {
        max-width: 120px;
        top: 10px;
        right: 10px;
      }
    }
    @keyframes movieFrames {
      0% { opacity: 0; transform: translateY(20px); }
      5% { opacity: 1; transform: translateY(0); }
      20% { opacity: 1; transform: translateY(0); }
      25% { opacity: 0; transform: translateY(-20px); }
      100% { opacity: 0; }
    }

    .movie-scene {
      animation-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
    }
    .menu-toggle {
      position: fixed;
      top: 10px;
      left: 10px;
      z-index: 1001;
      background: rgba(255,255,255,0.9);
      border: none;
      border-radius: 50%;
      padding: 8px;
      cursor: pointer;
      box-shadow: 0 0 15px rgba(0,150,255,0.3);
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .menu-toggle svg {
      width: 20px;
      height: 20px;
    }
    .tabs {
      position: fixed;
      top: 60px;
      left: 10px;
      flex-direction: column;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      padding: 10px;
      box-shadow: 0 8px 32px rgba(0, 91, 150, 0.2);
      display: none;
      z-index: 1000;
      opacity: 0;
      transform: translateX(-10px);
      transition: 0.3s all cubic-bezier(0.4, 0, 0.2, 1);
      max-height: 80vh;
      overflow-y: auto;
    }
    .tabs.show {
      display: flex;
      opacity: 1;
      transform: translateX(0);
    }
    @media (max-width: 768px) {
      .tabs {
        width: calc(100% - 20px);
        left: 10px;
        right: 10px;
        top: 60px;
      }
      .menu-toggle {
        top: 5px;
        left: 5px;
      }
    }
  </style>
</head>
<body>
  <div class="parallax-background"></div>
  <div class="top-right-logo">
    <img src="/Novo Projeto (4).png" alt="SMOKE Games Logo" />
  </div>
  <div id="root">
    <!-- Add floating bubbles background -->
    <div class="bubble" style="width: 300px; height: 300px; top: 20%; left: 10%"></div>
    <div class="bubble" style="width: 200px; height: 200px; top: 60%; right: 15%"></div>
    <div class="bubble" style="width: 250px; height: 250px; bottom: 10%; left: 30%"></div>

    <script type="text/babel">
      const room = new WebsimSocket();
      const PASSWORD_ATTEMPT_LIMIT = 17;
      const LOCKOUT_DURATION = 120000; // 2 minutos

      function validatePassword(password) {
        return password.length <= 12;
      }

      async function hashPassword(password) {
        return CryptoJS.SHA256(password).toString();
      }

      function App() {
        const [activeTab, setActiveTab] = React.useState('home');
        const [selectedProfile, setSelectedProfile] = React.useState(null);
        const [newPost, setNewPost] = React.useState('');
        const [displayName, setDisplayName] = React.useState('');
        const [mediaFiles, setMediaFiles] = React.useState([]);
        const [uploading, setUploading] = React.useState(false);
        const [searchQuery, setSearchQuery] = React.useState('');
        const [viewMode, setViewMode] = React.useState('all');
        const [showGuidelines, setShowGuidelines] = React.useState(false);
        const [expandedComments, setExpandedComments] = React.useState({});
        const [password, setPassword] = React.useState('');
        const [notificationsEnabled, setNotificationsEnabled] = React.useState({});
        const [selectedFriend, setSelectedFriend] = React.useState(null);
        const [newMessage, setNewMessage] = React.useState('');
        const [menuOpen, setMenuOpen] = React.useState(false);
        
        const posts = React.useSyncExternalStore(
          room.collection('post').subscribe,
          () => room.collection('post').getList().reverse()
        );
        
        const users = React.useSyncExternalStore(
          room.collection('user').subscribe,
          () => room.collection('user').getList()
        );
        
        const likes = React.useSyncExternalStore(
          room.collection('like').subscribe,
          () => room.collection('like').getList()
        );
        
        const dislikes = React.useSyncExternalStore(
          room.collection('dislike').subscribe,
          () => room.collection('dislike').getList()
        );
        
        const comments = React.useSyncExternalStore(
          room.collection('comment').subscribe,
          () => room.collection('comment').getList()
        );

        const presence = React.useSyncExternalStore(
          room.party.subscribePresence,
          () => room.party.presence
        );

        const friends = React.useSyncExternalStore(
          room.collection('friend').subscribe,
          () => room.collection('friend').getList()
        );

        const friendRequests = React.useSyncExternalStore(
          room.collection('friend_request').subscribe,
          () => room.collection('friend_request').getList()
        );

        const privateMessages = React.useSyncExternalStore(
          room.collection('private_message').subscribe,
          () => room.collection('private_message').getList().reverse()
        );

        const groupMessages = React.useSyncExternalStore(
          room.collection('group_message').subscribe,
          () => room.collection('group_message').getList().reverse()
        );

        const userPosts = posts.filter(post => post.username === selectedProfile);
        const profileUser = users.find(u => u.username === selectedProfile);
        const userMedia = userPosts.flatMap(post => 
          post.media?.map(m => ({...m, postId: post.id})) || []
        );

        const [creatingGroup, setCreatingGroup] = React.useState(false);
        const [groupTitle, setGroupTitle] = React.useState('');
        const [groupDesc, setGroupDesc] = React.useState('');
        const [groupPhoto, setGroupPhoto] = React.useState(null);
        const [selectedFriendsToInvite, setSelectedFriendsToInvite] = React.useState([]);
        const [editingGroup, setEditingGroup] = React.useState(null);

        const groups = React.useSyncExternalStore(
          room.collection('group').subscribe,
          () => room.collection('group').getList().reverse()
        );

        const groupMembers = React.useSyncExternalStore(
          room.collection('group_member').subscribe,
          () => room.collection('group_member').getList()
        );

        const groupInvitations = React.useSyncExternalStore(
          room.collection('group_invitation').subscribe,
          () => room.collection('group_invitation').getList()
        );

        const aiMovies = React.useSyncExternalStore(
          room.collection('ai_movie').subscribe,
          () => room.collection('ai_movie').getList().reverse()
        );

        React.useEffect(() => {
          const subscriptions = room.collection('notification_subscription')
            .filter({ subscriber: room.party.client.username })
            .getList();
          const enabled = {};
          subscriptions.forEach(sub => {
            enabled[sub.targetUser] = true;
          });
          setNotificationsEnabled(enabled);
        }, []);

        room.onmessage = (event) => {
          if (event.data.type === 'post-created' && 
              notificationsEnabled[event.data.username]) {
            const audio = new Audio('/BeepBox-Song.mp3');
            audio.play();
          }
        };

        const handleToggleNotifications = async (targetUser) => {
          const existingSub = room.collection('notification_subscription')
            .filter({ 
              targetUser,
              subscriber: room.party.client.username 
            })
            .getList()[0];

          if (existingSub) {
            await room.collection('notification_subscription').delete(existingSub.id);
            setNotificationsEnabled(prev => ({...prev, [targetUser]: false}));
          } else {
            await room.collection('notification_subscription').create({
              targetUser,
              subscriber: room.party.client.username
            });
            setNotificationsEnabled(prev => ({...prev, [targetUser]: true}));
          }
        };

        const handleSubmit = async (e) => {
          e.preventDefault();
          if (!users.find(u => u.username === room.party.client.username)) {
            alert('Crie uma conta para postar!');
            return;
          }
          if (!newPost.trim()) return;
          await room.collection('post').create({ 
            content: newPost,
            displayName: users.find(u => u.username === room.party.client.username).displayName,
            media: mediaFiles
          });
          room.send({
            type: 'post-created',
            username: room.party.client.username
          });
          const subscribers = room.collection('notification_subscription')
            .filter({ targetUser: room.party.client.username })
            .getList();

          subscribers.forEach(async sub => {
            const user = room.collection('user')
              .filter({ username: sub.subscriber })
              .getList()[0];
            
            if (user.email) {
              try {
                await websim.callApi('/api/send-email', {
                  method: 'POST',
                  body: {
                    to: user.email,
                    subject: `${room.party.client.username} fez uma nova postagem`,
                    text: `Nova postagem: "${newPost.substring(0, 50)}..."\n\nAcesse: ${window.location.href}`
                  }
                });
              } catch (error) {
                console.error('Erro ao enviar e-mail:', error);
              }
            }
          });
          setNewPost('');
          setMediaFiles([]);
        };

        const handleLike = async (postId) => {
          // Remove any existing dislikes from same user
          dislikes.filter(d => 
            d.post_id === postId && 
            d.username === room.party.client.username
          ).forEach(async dislike => {
            await room.collection('dislike').delete(dislike.id);
          });

          const existingLike = likes.find(like => 
            like.post_id === postId && 
            like.username === room.party.client.username
          );
          
          if (!existingLike) {
            await room.collection('like').create({ post_id: postId });
          }
        };

        const handleDislike = async (postId) => {
          likes.filter(like => 
            like.post_id === postId &&
            like.username === room.party.client.username
          ).forEach(async like => {
            await room.collection('like').delete(like.id);
          });

          const existingDislike = dislikes.find(d => 
            d.post_id === postId && 
            d.username === room.party.client.username
          );
          
          if (!existingDislike) {
            await room.collection('dislike').create({ post_id: postId });
          }
        };

        const handleComment = async (postId, commentText) => {
          if (!commentText.trim()) return;
          
          // Add check for registered user
          if (!users.find(u => u.username === room.party.client.username)) {
            alert('Crie uma conta para comentar!');
            return;
          }

          await room.collection('comment').create({
            post_id: postId,
            content: commentText
          });
        };

        const handleShare = (postId) => {
          const postUrl = `${window.location.origin}/post/${postId}`;
          navigator.clipboard.writeText(postUrl);
          alert('Link copiado para a área de transferência!');
        };

        const handleRegister = async (e) => {
          e.preventDefault();
          const password = e.target.elements.password.value;
          const email = e.target.elements.email.value;
          
          if (!password.match(/^(?=.*[A-Z]).{6,12}$/)) {
            alert('Senha deve ter 6 a 12 caracteres com pelo menos uma letra maiúscula');
            return;
          }

          try {
            const users = room.collection('user').getList();
            const existingUser = users.find(u => u.username === room.party.client.username);

            if (existingUser) {
              alert('Usuário já existe!');
              return;
            }

            const passwordHash = CryptoJS.SHA256(password).toString();

            await room.collection('user').create({
              displayName: displayName.trim(),
              email: email,
              username: room.party.client.username,
              passwordHash: passwordHash,
              favoriteGame: e.target.elements['favorite-game'].value,
              createdAt: new Date().toISOString(),
              avatarUrl: '/df0c850a7360e09ef4657abdec73b684.png'
            });
            alert('Registro realizado com sucesso!');
            window.location.reload();

          } catch (error) {
            console.error('Erro no registro:', error);
            alert('Erro: ' + error.message);
          }
        };

        const handleLogin = async (username, password) => {
          const user = room.collection('user')
            .filter({ username })
            .getList()[0];

          if (!user || CryptoJS.SHA256(password).toString() !== user.passwordHash) {
            alert('Credenciais inválidas ou usuário não encontrado');
            return false;
          }

          return true;
        };

        const buttonStyle = {
          background: 'none',
          border: 'none',
          cursor: 'pointer',
          display: 'flex',
          alignItems: 'center',
          gap: '4px',
          padding: '6px 12px',
          borderRadius: '20px',
          backgroundColor: '#1e90ff', /* Azul */
          color: 'white'
        };

        const filteredPosts = posts.filter(post => {
          if(viewMode === 'liked') {
            return likes.some(like => 
              like.post_id === post.id && 
              like.username === room.party.client.username
            );
          }
          return true;
        }).sort((a,b) => {
          if(viewMode === 'recommended') {
            const aLikes = likes.filter(l => l.post_id === a.id).length;
            const bLikes = likes.filter(l => l.post_id === b.id).length;
            return bLikes - aLikes;
          }
          return 0;
        });

        const guidelinesContent = (
          <div className="guidelines-box">
            <h3>📘 Guia de Uso da Comunidade</h3>
            <h4>📝 Como criar uma conta:</h4>
            <ol>
              <li>Clique na aba <strong>"Conta"</strong></li>
              <li>Preencha o formulário com e-mail válido</li>
              <li>Crie uma senha de 6 a 12 dígitos contendo:
                <ul>
                  <li>Pelo menos 1 letra MAIÚSCULA</li>
                  <li>Não use sequências óbvias (ex: 123456)</li>
                </ul>
              </li>
              <li>Selecione seu jogo favorito</li>
              <li>Clique em <strong>"Criar Conta"</strong></li>
            </ol>

            <h4>🤝 Sistema de Amizades:</h4>
            <ol>
              <li>Visite o perfil do usuário</li>
              <li>Clique em <strong>"Enviar solicitação"</strong></li>
              <li>Após aceitação, aparecerá na lista de amigos</li>
            </ol>

            <h4>💬 Conversas Privadas:</h4>
            <ol>
              <li>Na aba <strong>"Conversas"</strong> selecione um amigo</li>
              <li>Digite sua mensagem no campo abaixo</li>
              <li>Clique em <strong>"Enviar"</strong></li>
              <li>Histórico de conversas é salvo automaticamente</li>
            </ol>

            <h4>👥 Grupos:</h4>
            <ol>
              <li>Clique em <strong>"Criar Novo Grupo"</strong>
                <ul>
                  <li>Título obrigatório</li>
                  <li>Foto e descrição opcionais</li>
                </ul>
              </li>
              <li>Convide amigos da lista</li>
              <li>Os convites aparecerão na aba grupos dos amigos</li>
              <li>Após aceitação, poderão participar do chat do grupo</li>
            </ol>

            <h4>🔔 Notificações:</h4>
            <ul>
              <li>Clique no ícone de sino nos perfis para ativar/desativar</li>
              <li>Receba alertas sonoros quando houver novas postagens</li>
              <li>Notificações por e-mail para posts importantes</li>
            </ul>
          </div>
        );

        const handleCreateGroup = async (e) => {
          e.preventDefault();
          if (!groupTitle.trim()) {
            alert('Título do grupo é obrigatório!');
            return;
          }
          
          const groupData = {
            title: groupTitle,
            description: groupDesc,
            owner: room.party.client.username,
            createdAt: new Date().toISOString()
          };

          if (groupPhoto) {
            try {
              const url = await websim.upload(groupPhoto);
              groupData.photoUrl = url;
            } catch (error) {
              console.error('Erro no upload da foto:', error);
            }
          }

          const newGroup = await room.collection('group').create(groupData);

          // Add owner as member
          await room.collection('group_member').create({
            groupId: newGroup.id,
            username: room.party.client.username
          });

          // Process invitations
          selectedFriendsToInvite.forEach(async (friend) => {
            await room.collection('group_invitation').create({
              groupId: newGroup.id,
              inviter: room.party.client.username,
              invitee: friend,
              status: 'pending'
            });
          });

          setCreatingGroup(false);
          setGroupTitle('');
          setGroupDesc('');
          setGroupPhoto(null);
          setSelectedFriendsToInvite([]);
        };

        const handleGroupInviteResponse = async (invitationId, accept) => {
          await room.collection('group_invitation').update(invitationId, {
            status: accept ? 'accepted' : 'declined'
          });

          if (accept) {
            const invitation = groupInvitations.find(i => i.id === invitationId);
            // Adicionar como membro do grupo após aceitar
            await room.collection('group_member').create({
              groupId: invitation.groupId,
              username: invitation.invitee
            });
            
            // Atualizar a lista de grupos imediatamente
            window.location.reload();
          }
        };

        const handleSendGroupMessage = async (groupId, messageText) => {
          if (!messageText.trim()) return;
          
          await room.collection('group_message').create({
            groupId,
            content: messageText,
            sender: room.party.client.username
          });
        };

        if (selectedProfile) {
          const isMyProfile = selectedProfile === room.party.client.username;
          const existingRequest = friendRequests.find(req => 
            (req.from === room.party.client.username && req.to === selectedProfile) ||
            (req.to === room.party.client.username && req.from === selectedProfile)
          );

          return (
            <div className="container">
              <div style={{display: 'flex', alignItems: 'center', marginBottom: '20px'}}>
                <button onClick={() => setSelectedProfile(null)} style={buttonStyle}>
                  ← Voltar
                </button>
                <h1 style={{marginLeft: '20px'}}>Perfil de {profileUser?.displayName || selectedProfile}</h1>
              </div>

              <div className="post" style={{marginBottom: '20px'}}>
                <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                  <div style={{position: 'relative'}}>
                    <img 
                      src={profileUser?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                      style={{width: '80px', height: '80px', borderRadius: '50%'}}
                      alt="Avatar"
                    />
                    {isMyProfile && (
                      <label htmlFor="avatar-upload" style={{
                        position: 'absolute',
                        bottom: 0,
                        right: 0,
                        background: '#00c8ff',
                        borderRadius: '50%',
                        padding: '4px',
                        cursor: 'pointer'
                      }}>
                        📷
                        <input
                          type="file"
                          id="avatar-upload"
                          accept="image/*"
                          style={{display: 'none'}}
                          onChange={async (e) => {
                            const file = e.target.files[0];
                            if (file) {
                              try {
                                const url = await websim.upload(file);
                                await room.collection('user').update(
                                  users.find(u => u.username === room.party.client.username).id,
                                  { avatarUrl: url }
                                );
                              } catch (error) {
                                console.error('Erro no upload:', error);
                                alert('Erro ao atualizar avatar!');
                              }
                            }
                          }}
                        />
                      </label>
                    )}
                  </div>
                  <div>
                    <h2>{profileUser?.displayName || selectedProfile}</h2>
                    <p>@{selectedProfile}</p>
                    <p> Amigos: {friends.filter(f => 
                      f.users.includes(selectedProfile)).length}</p>
                    {!isMyProfile && (
                      <div style={{display: 'flex', gap: '10px', marginTop: '10px'}}>
                        <button
                          className="frutiger-reaction-button"
                          onClick={() => handleToggleNotifications(selectedProfile)}
                        >
                          {notificationsEnabled[selectedProfile] ? '🔔 Ativo' : '🔕 Ativar Notificações'}
                        </button>
                        <button 
                          onClick={async () => {
                            if (!existingRequest) {
                              await room.collection('friend_request').create({
                                from: room.party.client.username,
                                to: selectedProfile,
                                status: 'pending'
                              });
                            } else if (existingRequest.status === 'pending' && existingRequest.to === room.party.client.username) {
                              await room.collection('friend_request').update(existingRequest.id, {
                                status: 'accepted'
                              });
                              await room.collection('friend').create({
                                users: [existingRequest.from, existingRequest.to]
                              });
                            }
                          }}
                          style={buttonStyle}
                        >
                          {!existingRequest ? ' Enviar solicitação' :
                           existingRequest.status === 'pending' && existingRequest.to === room.party.client.username ? ' Pendente' :
                           existingRequest.status === 'accepted' ? ' Amigos' : ' Responder solicitação'}
                        </button>
                      </div>
                    )}
                  </div>
                </div>
              </div>

              <h3>Postagens ({userPosts.length})</h3>
              {userPosts.map(post => (
                <div key={post.id} className="post">
                  <div style={{display: 'flex', marginBottom: '12px'}}>
                    <button 
                      onClick={() => setSelectedProfile(post.username)}
                      style={{border: 'none', background: 'none', padding: 0}}
                    >
                      <img 
                        src={users.find(u => u.username === post.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                        style={{width: '40px', height: '40px', borderRadius: '50%'}}
                        alt="Avatar"
                      />
                    </button>
                    <div>
                      <div style={{fontWeight: 'bold'}}>{post.displayName || post.username}</div>
                      <div style={{color: '#ccc', fontSize: '0.9em'}}>
                        {new Date(post.created_at).toLocaleString()}
                      </div>
                    </div>
                  </div>
                  <p style={{margin: '0 0 12px 0'}}>{post.content}</p>
                  {post.media?.length > 0 && (
                    <div style={{
                      display: 'grid',
                      gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
                      gap: '8px',
                      margin: '12px 0'
                    }}>
                      {post.media.map((media, idx) => (
                        media.type === 'video' ? (
                          <video 
                            key={idx}
                            controls
                            style={{
                              width: '100%',
                              height: 'auto',
                              aspectRatio: '16/9',
                              borderRadius: '8px',
                              maxWidth: '100%',
                              maxHeight: '80vh'
                            }}
                            src={media.url}
                          />
                        ) : (
                          <img
                            key={idx}
                            src={media.url}
                            style={{
                              width: '100%',
                              height: '150px',
                              objectFit: 'cover',
                              borderRadius: '8px'
                            }}
                            alt={`Mídia ${idx + 1}`}
                          />
                        )
                      ))}
                    </div>
                  )}
                  <div style={{display: 'flex', gap: '16px', marginBottom: '12px'}}>
                    <button className="frutiger-reaction-button" onClick={() => handleLike(post.id)}>
                      👍 {likes.filter(l => l.post_id === post.id).length}
                    </button>
                    <button className="frutiger-reaction-button" onClick={() => handleDislike(post.id)}>
                      👎 {dislikes.filter(d => d.post_id === post.id).length}
                    </button>
                    <button className="frutiger-reaction-button" onClick={() => setExpandedComments(prev => ({
                      ...prev,
                      [post.id]: !prev[post.id]
                    }))}>
                      💬 {comments.filter(c => c.post_id === post.id).length}
                    </button>
                    <button className="frutiger-reaction-button" onClick={() => handleShare(post.id)}>
                      ↗️ Compartilhar
                    </button>
                  </div>
                  {expandedComments[post.id] && (
                    <>
                      {comments.filter(c => c.post_id === post.id).map(comment => (
                        <div key={comment.id} style={{marginLeft: '32px', marginTop: '8px'}}>
                          <div style={{display: 'flex', alignItems: 'center'}}>
                            <img
                              src={users.find(u => u.username === comment.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                              style={{width: '24px', height: '24px', borderRadius: '50%'}}
                              alt="Avatar"
                            />
                            <span style={{fontWeight: '500'}}>{comment.username}:</span>
                          </div>
                          <p style={{marginLeft: '32px'}}>{comment.content}</p>
                        </div>
                      ))}
                      <form 
                        onSubmit={(e) => {
                          e.preventDefault();
                          const commentText = e.target.comment.value;
                          handleComment(post.id, commentText);
                          e.target.comment.value = '';
                        }}
                        style={{marginTop: '12px'}}
                      >
                        <input
                          type="text"
                          name="comment"
                          placeholder="Adicione um comentário..."
                          style={{
                            width: '100%',
                            padding: '8px',
                            border: '1px solid #555',
                            borderRadius: '20px'
                          }}
                        />
                      </form>
                    </>
                  )}
                </div>
              ))}

              <h3>Mídias ({userMedia.length})</h3>
              <div style={{
                display: 'grid',
                gridTemplateColumns: 'repeat(auto-fit, minmax(150px, 1fr))',
                gap: '10px',
                marginBottom: '20px'
              }}>
                {userMedia.map((media, idx) => (
                  media.type === 'video' ? (
                    <video
                      key={idx}
                      controls
                      style={{
                        width: '100%',
                        height: 'auto',
                        aspectRatio: '16/9',
                        borderRadius: '8px',
                        maxWidth: '100%',
                        maxHeight: '80vh'
                      }}
                      src={media.url}
                    />
                  ) : (
                    <img
                      key={idx}
                      src={media.url}
                      style={{
                        width: '100%',
                        height: '150px',
                        objectFit: 'cover',
                        borderRadius: '8px'
                      }}
                      alt={`Mídia ${idx + 1}`}
                    />
                  )
                ))}
              </div>
            </div>
          );
        }

        return (
          <div className="container">
            <div className="menu-toggle" onClick={() => setMenuOpen(!menuOpen)}>
              <svg viewBox="0 0 24 24">
                <path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/>
              </svg>
            </div>

            <div className={`tabs ${menuOpen ? 'show' : ''}`}>
              <button 
                className={`tab-button ${activeTab === 'home' ? 'active' : ''}`}
                onClick={() => { setActiveTab('home'); setMenuOpen(false); }}
              >
                Home
              </button>
              <button 
                className={`tab-button ${activeTab === 'discover' ? 'active' : ''}`}
                onClick={() => { setActiveTab('discover'); setMenuOpen(false); }}
              >
                Descubra
              </button>
              <button 
                className={`tab-button ${activeTab === 'account' ? 'active' : ''}`}
                onClick={() => { setActiveTab('account'); setMenuOpen(false); }}
              >
                Conta
              </button>
              <button 
                className={`tab-button ${activeTab === 'chats' ? 'active' : ''}`}
                onClick={() => { setActiveTab('chats'); setMenuOpen(false); }}
              >
                Conversas
              </button>
              <button 
                className={`tab-button ${activeTab === 'groups' ? 'active' : ''}`}
                onClick={() => { setActiveTab('groups'); setMenuOpen(false); }}
              >
                Grupos
              </button>
              <button 
                className={`tab-button ${activeTab === 'movies' ? 'active' : ''}`}
                onClick={() => { setActiveTab('movies'); setMenuOpen(false); }}
              >
                🎬 Filmes AI
              </button>
            </div>

            {activeTab === 'account' && (
              <div className="login-form">
                {users.find(u => u.username === room.party.client.username) ? (
                  <div>
                    <h2>Sua Conta</h2>
                    <div style={{display: 'flex', gap: '20px', alignItems: 'center', marginBottom: '20px'}}>
                      <div style={{position: 'relative'}}>
                        <img 
                          src={users.find(u => u.username === room.party.client.username).avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                          style={{width: '80px', height: '80px', borderRadius: '50%'}}
                          alt="Avatar"
                        />
                        <label htmlFor="avatar-upload-account" style={{
                          position: 'absolute',
                          bottom: 0,
                          right: 0,
                          background: '#00c8ff',
                          borderRadius: '50%',
                          padding: '4px',
                          cursor: 'pointer'
                        }}>
                          📷
                          <input
                            type="file"
                            id="avatar-upload-account"
                            accept="image/*"
                            style={{display: 'none'}}
                            onChange={async (e) => {
                              const file = e.target.files[0];
                              if (file) {
                                try {
                                  const url = await websim.upload(file);
                                  await room.collection('user').update(
                                    users.find(u => u.username === room.party.client.username).id,
                                    { avatarUrl: url }
                                  );
                                } catch (error) {
                                  console.error('Erro no upload:', error);
                                  alert('Erro ao atualizar avatar!');
                                }
                              }
                            }}
                          />
                        </label>
                      </div>
                      <div>
                        <p>Nome: {users.find(u => u.username === room.party.client.username).displayName}</p>
                        <p>Usuário: {room.party.client.username}</p>
                      </div>
                    </div>
                    {/* Adicionado formulário de postagem na aba conta */}
                    <form onSubmit={handleSubmit} style={{margin: '20px 0', padding: '20px', background: 'rgba(255,255,255,0.2)', borderRadius: '12px'}}>
                      <textarea
                        value={newPost}
                        onChange={(e) => setNewPost(e.target.value)}
                        placeholder="Criar nova postagem..."
                        style={{
                          width: '100%',
                          padding: '12px',
                          borderRadius: '8px',
                          border: '1px solid #555',
                          marginBottom: '8px'
                        }}
                      />
                      <div style={{display: 'flex', gap: '8px', margin: '8px 0'}}>
                        <input
                          type="file"
                          id="media-upload"
                          multiple
                          accept="image/*,video/*"
                          style={{display: 'none'}}
                          onChange={async (e) => {
                            setUploading(true);
                            const files = Array.from(e.target.files);
                            const uploaded = [];
                            for (const file of files) {
                              try {
                                const url = await websim.upload(file);
                                uploaded.push({ url, type: file.type.startsWith('video') ? 'video' : 'image' });
                              } catch (error) {
                                console.error('Upload failed:', error);
                              }
                            }
                            setMediaFiles(uploaded);
                            setUploading(false);
                          }}
                        />
                        <label htmlFor="media-upload" style={{
                          cursor: 'pointer',
                          padding: '8px',
                          border: '1px dashed #555',
                          borderRadius: '8px'
                        }}>
                          Adicionar Mídia
                        </label>
                        {uploading && <span>Enviando...</span>}
                      </div>
                      <button 
                        type="submit"
                        style={{
                          background: '#1e90ff',
                          color: 'white',
                          border: 'none',
                          padding: '8px 16px',
                          borderRadius: '20px',
                          cursor: 'pointer'
                        }}
                      >
                        Publicar
                      </button>
                    </form>
                    <h3>Amigos ({friends.filter(f => f.users.includes(room.party.client.username)).length})</h3>
                    {friends
                      .filter(f => f.users.includes(room.party.client.username))
                      .map(friend => (
                        <div key={friend.id} className="post" style={{padding: '10px', margin: '10px 0'}}>
                          @{friend.users.find(u => u !== room.party.client.username)}
                          <button 
                            onClick={async () => {
                              if (confirm('Tem certeza que deseja apagar esta postagem?')) {
                                await room.collection('friend').delete(friend.id);
                              }
                            }}
                            style={{...buttonStyle, backgroundColor: '#ff4444', float: 'right'}}
                          >
                            Remover
                          </button>
                        </div>
                      ))}
                    <h4>Solicitações Pendentes</h4>
                    {friendRequests
                      .filter(req => req.to === room.party.client.username && req.status === 'pending')
                      .map(req => (
                        <div key={req.id} className="post" style={{padding: '10px', margin: '10px 0'}}>
                          <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <span>@{req.from}</span>
                            <div>
                              <button 
                                onClick={async () => {
                                  await room.collection('friend_request').update(req.id, {status: 'accepted'});
                                  await room.collection('friend').create({
                                    users: [req.from, req.to]
                                  });
                                }}
                                style={buttonStyle}
                              >
                                Aceitar
                              </button>
                              <button 
                                onClick={() => room.collection('friend_request').update(req.id, {status: 'declined'})}
                                style={{...buttonStyle, backgroundColor: '#ff4444'}}
                              >
                                Recusar
                              </button>
                            </div>
                          </div>
                        </div>
                      ))}
                  </div>
                ) : (
                  <form onSubmit={handleRegister}>
                    <h2>Criar Conta</h2>
                    <input
                      type="email"
                      name="email"
                      placeholder="Seu e-mail"
                      required
                      style={{width: '100%', marginBottom: '10px', padding: '8px'}}
                    />
                    <input
                      type="text"
                      value={displayName}
                      onChange={(e) => setDisplayName(e.target.value)}
                      placeholder="Escolha um nome de exibição"
                      style={{width: '100%', marginBottom: '10px', padding: '8px'}}
                      required
                    />
                    <input
                      type="password"
                      name="password"
                      placeholder="Senha (6-12 caracteres)"
                      minLength="6"
                      maxLength="12"
                      required
                      style={{width: '100%', marginBottom: '10px', padding: '8px'}}
                    />
                    <div style={{marginBottom: '10px'}}>
                      <label>Seu Jogo Favorito: </label>
                      <select
                        name="favorite-game"
                        style={{marginLeft: '10px', padding: '5px', borderRadius: '5px'}}
                        required
                      >
                        <option value="Nenhum">Selecione um jogo</option>
                        <option value="GTA VI">GTA VI</option>
                        <option value="The Legend of Zelda: Tears of the Kingdom">The Legend of Zelda: Tears of the Kingdom</option>
                        <option value="Starfield">Starfield</option>
                        <option value="Hogwarts Legacy">Hogwarts Legacy</option>
                        <option value="Elden Ring: Shadow of the Erdtree">Elden Ring: Shadow of the Erdtree</option>
                        <option value="Call of Duty: Modern Warfare III">Call of Duty: Modern Warfare III</option>
                      </select>
                    </div>
                    <button type="submit" className="tab-button">
                      Criar Conta
                    </button>
                  </form>
                )}
              </div>
            )}

            {activeTab === 'home' && (
              <div style={{marginBottom: '24px'}}>
                <div style={{display: 'flex', justifyContent: 'center', flexWrap: 'wrap'}}>
                  <button className="frutiger-button" onClick={() => setViewMode('liked')}>
                    <img src="/517.png" alt="Favoritos" />
                    Postagens Curtidas
                  </button>
                  <button className="frutiger-button" onClick={() => setViewMode('recommended')}>
                    <img src="/514.png" alt="Recomendados" />
                    Recomendados
                  </button>
                  <button 
                    onClick={() => setShowGuidelines(!showGuidelines)}
                    className="frutiger-button"
                  >
                    <img src="/513.png" alt="Como Usar" />
                    Como Usar
                  </button>
                </div>
                
                {showGuidelines && guidelinesContent}

                {filteredPosts.map(post => (
                  <div key={post.id} className="post">
                    <div style={{display: 'flex', marginBottom: '12px'}}>
                      <button 
                        onClick={() => setSelectedProfile(post.username)}
                        style={{border: 'none', background: 'none', padding: 0}}
                      >
                        <img 
                          src={users.find(u => u.username === post.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                          style={{width: '40px', height: '40px', borderRadius: '50%', cursor: 'pointer'}}
                          alt={post.username}
                        />
                      </button>
                      <div>
                        <div style={{fontWeight: 'bold'}}>{post.displayName || post.username}</div>
                        <div style={{color: '#ccc', fontSize: '0.9em'}}>
                          {new Date(post.created_at).toLocaleString()}
                        </div>
                      </div>
                    </div>
                    <p style={{margin: '0 0 12px 0'}}>{post.content}</p>
                    {post.media?.length > 0 && (
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
                        gap: '8px',
                        margin: '12px 0'
                      }}>
                        {post.media.map((media, idx) => (
                          media.type === 'video' ? (
                            <video 
                              key={idx}
                              controls
                              style={{
                                width: '100%',
                                height: 'auto',
                                aspectRatio: '16/9',
                                borderRadius: '8px',
                                maxWidth: '100%',
                                maxHeight: '80vh'
                              }}
                              src={media.url}
                            />
                          ) : (
                            <img
                              key={idx}
                              src={media.url}
                              style={{
                                width: '100%',
                                height: '150px',
                                objectFit: 'cover',
                                borderRadius: '8px'
                              }}
                              alt={`Mídia ${idx + 1}`}
                            />
                          )
                        ))}
                      </div>
                    )}
                    <div style={{display: 'flex', gap: '16px', marginBottom: '12px'}}>
                      <button className="frutiger-reaction-button" onClick={() => handleLike(post.id)}>
                        👍 {likes.filter(l => l.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => handleDislike(post.id)}>
                        👎 {dislikes.filter(d => d.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => setExpandedComments(prev => ({
                        ...prev,
                        [post.id]: !prev[post.id]
                      }))}>
                        💬 {comments.filter(c => c.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => handleShare(post.id)}>
                        ↗️ Compartilhar
                      </button>
                      {post.username === room.party.client.username && (
                        <button 
                          onClick={async () => {
                            if (confirm('Tem certeza que deseja apagar esta postagem?')) {
                              await room.collection('post').delete(post.id);
                              // Also delete associated likes/comments
                              likes.filter(l => l.post_id === post.id)
                                .forEach(like => room.collection('like').delete(like.id));
                              comments.filter(c => c.post_id === post.id)
                                .forEach(comment => room.collection('comment').delete(comment.id));
                            }
                          }}
                          style={{...buttonStyle, backgroundColor: '#ff4444'}}
                        >
                          🗑️ Apagar
                        </button>
                      )}
                    </div>
                    {expandedComments[post.id] && (
                      <>
                        {comments.filter(c => c.post_id === post.id).map(comment => (
                          <div key={comment.id} style={{marginLeft: '32px', marginTop: '8px'}}>
                            <div style={{display: 'flex', alignItems: 'center'}}>
                              <img
                                src={users.find(u => u.username === comment.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                                style={{width: '24px', height: '24px', borderRadius: '50%', marginRight: '8px'}}
                                alt={comment.username}
                              />
                              <span style={{fontWeight: '500'}}>{comment.username}:</span>
                            </div>
                            <p style={{marginLeft: '32px'}}>{comment.content}</p>
                          </div>
                        ))}
                        <form 
                          onSubmit={(e) => {
                            e.preventDefault();
                            const commentText = e.target.comment.value;
                            handleComment(post.id, commentText);
                            e.target.comment.value = '';
                          }}
                          style={{marginTop: '12px'}}
                        >
                          <input
                            type="text"
                            name="comment"
                            placeholder="Adicione um comentário..."
                            style={{
                              width: '100%',
                              padding: '8px',
                              border: '1px solid #555',
                              borderRadius: '20px'
                            }}
                          />
                        </form>
                      </>
                    )}
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'discover' && (
              <div>
                <h2>Postagens Aleatórias</h2>
                {posts.map(post => (
                  <div key={post.id} className="post">
                    <div style={{display: 'flex', marginBottom: '12px'}}>
                      <button 
                        onClick={() => setSelectedProfile(post.username)}
                        style={{border: 'none', background: 'none', padding: 0}}
                      >
                        <img 
                          src={users.find(u => u.username === post.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                          style={{width: '40px', height: '40px', borderRadius: '50%', cursor: 'pointer'}}
                          alt={post.username}
                        />
                      </button>
                      <div>
                        <div style={{fontWeight: 'bold'}}>{post.displayName || post.username}</div>
                        <div style={{color: '#ccc', fontSize: '0.9em'}}>
                          {new Date(post.created_at).toLocaleString()}
                        </div>
                      </div>
                    </div>
                    <p style={{margin: '0 0 12px 0'}}>{post.content}</p>
                    {post.media?.length > 0 && (
                      <div style={{
                        display: 'grid',
                        gridTemplateColumns: 'repeat(auto-fit, minmax(100px, 1fr))',
                        gap: '8px',
                        margin: '12px 0'
                      }}>
                        {post.media.map((media, idx) => (
                          media.type === 'video' ? (
                            <video 
                              key={idx}
                              controls
                              style={{
                                width: '100%',
                                height: 'auto',
                                aspectRatio: '16/9',
                                borderRadius: '8px',
                                maxWidth: '100%',
                                maxHeight: '80vh'
                              }}
                              src={media.url}
                            />
                          ) : (
                            <img
                              key={idx}
                              src={media.url}
                              style={{
                                width: '100%',
                                height: '150px',
                                objectFit: 'cover',
                                borderRadius: '8px'
                              }}
                              alt={`Mídia ${idx + 1}`}
                            />
                          )
                        ))}
                      </div>
                    )}
                    <div style={{display: 'flex', gap: '16px', marginBottom: '12px'}}>
                      <button className="frutiger-reaction-button" onClick={() => handleLike(post.id)}>
                        👍 {likes.filter(l => l.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => handleDislike(post.id)}>
                        👎 {dislikes.filter(d => d.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => setExpandedComments(prev => ({
                        ...prev,
                        [post.id]: !prev[post.id]
                      }))}>
                        💬 {comments.filter(c => c.post_id === post.id).length}
                      </button>
                      <button className="frutiger-reaction-button" onClick={() => handleShare(post.id)}>
                        ↗️ Compartilhar
                      </button>
                      {post.username === room.party.client.username && (
                        <button 
                          onClick={async () => {
                            if (confirm('Tem certeza que deseja apagar esta postagem?')) {
                              await room.collection('post').delete(post.id);
                              // Also delete associated likes/comments
                              likes.filter(l => l.post_id === post.id)
                                .forEach(like => room.collection('like').delete(like.id));
                              comments.filter(c => c.post_id === post.id)
                                .forEach(comment => room.collection('comment').delete(comment.id));
                            }
                          }}
                          style={{...buttonStyle, backgroundColor: '#ff4444'}}
                        >
                          🗑️ Apagar
                        </button>
                      )}
                    </div>
                    {expandedComments[post.id] && (
                      <>
                        {comments.filter(c => c.post_id === post.id).map(comment => (
                          <div key={comment.id} style={{marginLeft: '32px', marginTop: '8px'}}>
                            <div style={{display: 'flex', alignItems: 'center'}}>
                              <img
                                src={users.find(u => u.username === comment.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                                style={{width: '24px', height: '24px', borderRadius: '50%', marginRight: '8px'}}
                                alt={comment.username}
                              />
                              <span style={{fontWeight: '500'}}>{comment.username}:</span>
                            </div>
                            <p style={{marginLeft: '32px'}}>{comment.content}</p>
                          </div>
                        ))}
                        <form 
                          onSubmit={(e) => {
                            e.preventDefault();
                            const commentText = e.target.comment.value;
                            handleComment(post.id, commentText);
                            e.target.comment.value = '';
                          }}
                          style={{marginTop: '12px'}}
                        >
                          <input
                            type="text"
                            name="comment"
                            placeholder="Adicione um comentário..."
                            style={{
                              width: '100%',
                              padding: '8px',
                              border: '1px solid #555',
                              borderRadius: '20px'
                            }}
                          />
                        </form>
                      </>
                    )}
                  </div>
                ))}
              </div>
            )}

            {activeTab === 'chats' && (
              <div className="post" style={{display: 'flex', gap: '20px', minHeight: '60vh'}}>
                <div style={{flex: 1, borderRight: '1px solid rgba(0,0,0,0.1)', paddingRight: '20px'}}>
                  <h3>Amigos</h3>
                  {friends
                    .filter(f => f.users.includes(room.party.client.username))
                    .map(friend => {
                      const friendUsername = friend.users.find(u => u !== room.party.client.username);
                      return (
                        <div 
                          key={friend.id} 
                          className="post" 
                          style={{
                            cursor: 'pointer',
                            backgroundColor: selectedFriend === friendUsername ? 'rgba(0,200,255,0.1)' : 'transparent',
                            margin: '8px 0'
                          }}
                          onClick={() => setSelectedFriend(friendUsername)}
                        >
                          <div style={{display: 'flex', alignItems: 'center', gap: '10px'}}>
                            <img
                              src={users.find(u => u.username === friendUsername)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                              style={{width: '40px', height: '40px', borderRadius: '50%'}}
                              alt={friendUsername}
                            />
                            <span>@{friendUsername}</span>
                          </div>
                        </div>
                      );
                    })}
                </div>
                
                <div style={{flex: 3}}>
                  {selectedFriend ? (
                    <>
                      <div style={{
                        height: '50vh',
                        overflowY: 'auto',
                        marginBottom: '20px',
                        borderBottom: '1px solid rgba(0,0,0,0.1)'
                      }}>
                        {privateMessages
                          .filter(m => 
                            (m.sender === room.party.client.username && m.receiver === selectedFriend) ||
                            (m.sender === selectedFriend && m.receiver === room.party.client.username)
                          )
                          .map(message => (
                            <div 
                              key={message.id} 
                              style={{
                                margin: '8px 0',
                                textAlign: message.sender === room.party.client.username ? 'right' : 'left'
                              }}
                            >
                              <div style={{
                                display: 'inline-block',
                                background: message.sender === room.party.client.username ? 
                                  'linear-gradient(145deg, #00c8ff, #0099cc)' : 
                                  'rgba(0,0,0,0.05)',
                                color: message.sender === room.party.client.username ? 'white' : 'inherit',
                                padding: '8px 16px',
                                borderRadius: '20px',
                                maxWidth: '70%'
                              }}>
                                <p style={{margin: 0}}>{message.content}</p>
                                <small style={{opacity: 0.7}}>
                                  {new Date(message.created_at).toLocaleTimeString()}
                                </small>
                              </div>
                            </div>
                          ))}
                      </div>
                      
                      <form onSubmit={async (e) => {
                        e.preventDefault();
                        const commentText = e.target.comment.value;
                        handleComment(selectedFriend, commentText);
                        e.target.comment.value = '';
                      }}>
                        <input
                          type="text"
                          value={newMessage}
                          onChange={(e) => setNewMessage(e.target.value)}
                          placeholder="Escreva uma mensagem..."
                          style={{
                            width: '100%',
                            padding: '12px',
                            borderRadius: '20px',
                            border: '1px solid #555'
                          }}
                        />
                      </form>
                    </>
                  ) : (
                    <div style={{textAlign: 'center', opacity: 0.5, marginTop: '40px'}}>
                      Selecione um amigo para iniciar uma conversa
                    </div>
                  )}
                </div>
              </div>
            )}

            {activeTab === 'groups' && (
              <div className="post">
                {!creatingGroup && !editingGroup && (
                  <button 
                    className="frutiger-button"
                    onClick={() => setCreatingGroup(true)}
                  >
                    🆕 Criar Novo Grupo
                  </button>
                )}

                {/* Adicionar seção de convites pendentes */}
                <h3>Convites Pendentes</h3>
                {groupInvitations
                  .filter(i => 
                    i.invitee === room.party.client.username &&
                    i.status === 'pending'
                  )
                  .map(invitation => (
                    <div key={invitation.id} className="post" style={{margin: '10px 0'}}>
                      <div style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                        <div>
                          <p>Convite para: {groups.find(g => g.id === invitation.groupId)?.title}</p>
                          <small>Enviado por: @{invitation.inviter}</small>
                        </div>
                        <div style={{display: 'flex', gap: '8px'}}>
                          <button
                            className="frutiger-reaction-button"
                            onClick={() => handleGroupInviteResponse(invitation.id, true)}
                          >
                            ✅ Aceitar
                          </button>
                          <button
                            className="frutiger-reaction-button"
                            onClick={() => handleGroupInviteResponse(invitation.id, false)}
                          >
                            ❌ Recusar
                          </button>
                        </div>
                      </div>
                    </div>
                  ))}

                {creatingGroup && (
                  <form onSubmit={handleCreateGroup}>
                    <h2>Criar Novo Grupo</h2>
                    <input
                      type="text"
                      placeholder="Título do Grupo *"
                      value={groupTitle}
                      onChange={(e) => setGroupTitle(e.target.value)}
                      required
                    />
                    <textarea
                      placeholder="Descrição do Grupo"
                      value={groupDesc}
                      onChange={(e) => setGroupDesc(e.target.value)}
                    />
                    <input
                      type="file"
                      accept="image/*"
                      onChange={(e) => setGroupPhoto(e.target.files[0])}
                    />
                    
                    <h4>Convidar Amigos:</h4>
                    {friends
                      .filter(f => f.users.includes(room.party.client.username))
                      .map(friend => {
                        const friendUsername = friend.users.find(u => u !== room.party.client.username);
                        return (
                          <label key={friendUsername}>
                            <input
                              type="checkbox"
                              checked={selectedFriendsToInvite.includes(friendUsername)}
                              onChange={(e) => {
                                if (e.target.checked) {
                                  setSelectedFriendsToInvite([...selectedFriendsToInvite, friendUsername]);
                                } else {
                                  setSelectedFriendsToInvite(selectedFriendsToInvite.filter(u => u !== friendUsername));
                                }
                              }}
                            />
                            @{friendUsername}
                          </label>
                        );
                      })}
                    
                    <button type="submit" className="frutiger-button">
                      Criar Grupo
                    </button>
                    <button 
                      className="frutiger-button"
                      onClick={() => setCreatingGroup(false)}
                    >
                      Cancelar
                    </button>
                  </form>
                )}

                <h3>Seus Grupos</h3>
                {groups
                  .filter(g => groupMembers.some(m => 
                    m.groupId === g.id && m.username === room.party.client.username
                  ))
                  .map(group => (
                    <div key={group.id} className="post">
                      <div style={{display: 'flex', alignItems: 'center', gap: '20px'}}>
                        {group.photoUrl && (
                          <img 
                            src={group.photoUrl}
                            style={{width: '80px', height: '80px', borderRadius: '50%'}}
                            alt="Group"
                          />
                        )}
                        <div>
                          <h2>{group.title}</h2>
                          {group.description && <p>{group.description}</p>}
                          <p>Criado por: @{group.owner}</p>
                          
                          {group.owner === room.party.client.username && (
                            <button
                              className="frutiger-reaction-button"
                              onClick={() => setEditingGroup(group)}
                            >
                              ✏️ Editar Grupo
                            </button>
                          )}
                        </div>
                      </div>

                      <h4>Membros ({groupMembers.filter(m => m.groupId === group.id).length})</h4>
                      <div style={{display: 'flex', flexWrap: 'wrap', gap: '10px'}}>
                        {groupMembers
                          .filter(m => m.groupId === group.id)
                          .map(member => (
                            <div key={member.username} style={{display: 'flex', alignItems: 'center', gap: '5px'}}>
                              <img
                                src={users.find(u => u.username === member.username)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                                style={{width: '30px', height: '30px', borderRadius: '50%'}}
                                alt={member.username}
                              />
                              @{member.username}
                              {group.owner === member.username && ' 👑'}
                            </div>
                          ))}
                      </div>

                      {groupInvitations
                        .filter(i => i.groupId === group.id && i.status === 'pending')
                        .map(invitation => (
                          <div key={invitation.id} className="post">
                            @{invitation.invitee} - Convite pendente
                            {group.owner === room.party.client.username && (
                              <button 
                                onClick={() => room.collection('group_invitation').delete(invitation.id)}
                                className="frutiger-reaction-button"
                              >
                                Revogar
                              </button>
                            )}
                          </div>
                        ))}
                      {/* Group Chat Section */}
                      <div style={{
                        marginTop: '20px',
                        borderTop: '2px solid rgba(0,200,255,0.2)',
                        paddingTop: '20px'
                      }}>
                        <h4>Chat do Grupo</h4>
                        <div style={{
                          height: '300px',
                          overflowY: 'auto',
                          marginBottom: '20px',
                          backgroundColor: 'rgba(255,255,255,0.8)',
                          borderRadius: '12px',
                          padding: '15px'
                        }}>
                          {groupMessages
                            .filter(m => m.groupId === group.id)
                            .map(message => (
                              <div key={message.id} style={{
                                margin: '10px 0',
                                display: 'flex',
                                alignItems: 'flex-start',
                                gap: '10px'
                              }}>
                                <img
                                  src={users.find(u => u.username === message.sender)?.avatarUrl || '/df0c850a7360e09ef4657abdec73b684.png'}
                                  style={{width: '32px', height: '32px', borderRadius: '50%'}}
                                  alt={message.sender}
                                />
                                <div style={{flex: 1}}>
                                  <div style={{display: 'flex', gap: '8px', alignItems: 'baseline'}}>
                                    <strong>@{message.sender}</strong>
                                    <small style={{opacity: 0.7}}>
                                      {new Date(message.created_at).toLocaleTimeString()}
                                    </small>
                                  </div>
                                  <p style={{margin: '4px 0'}}>{message.content}</p>
                                </div>
                              </div>
                            ))}
                        </div>

                        <form onSubmit={async (e) => {
                          e.preventDefault();
                          const messageText = e.target.message.value;
                          await handleSendGroupMessage(group.id, messageText);
                          e.target.message.value = '';
                        }}>
                          <div style={{display: 'flex', gap: '8px'}}>
                            <input
                              type="text"
                              name="message"
                              placeholder="Escreva uma mensagem..."
                              style={{
                                flex: 1,
                                padding: '12px',
                                borderRadius: '20px',
                                border: '1px solid #555'
                              }}
                            />
                            <button 
                              type="submit"
                              className="frutiger-reaction-button"
                            >
                              Enviar
                            </button>
                          </div>
                        </form>
                      </div>
                    </div>
                  ))}
              </div>
            )}

            {activeTab === 'movies' && (
              <div className="post" style={{maxWidth: '800px', margin: '0 auto'}}>
                <h2>🎥 Filmes Gerados</h2>
                <div style={{marginBottom: '40px'}}>
                  <h3>Novo Filme AI</h3>
                  <form onSubmit={async (e) => {
                    e.preventDefault();
                    const prompt = e.target.elements.moviePrompt.value;
                    if (!prompt.trim()) return;

                    try {
                      const completion = await websim.chat.completions.create({
                        messages: [
                          {
                            role: "system",
                            content: `Gere uma ideia de filme baseada na descrição do usuário. 
                            Responda APENAS com JSON contendo: titulo, sinopse, genero, 
                            emojis relacionados, e diálogos formatados. Use o schema:
                            {
                              "titulo": string,
                              "sinopse": string,
                              "genero": string,
                              "emojis": string,
                              "dialogos": Array<{personagem: string, texto: string, cena: string}>
                            }`
                          },
                          {
                            role: "user",
                            content: prompt
                          }
                        ],
                        json: true
                      });

                      const movieData = JSON.parse(completion.content);
                      
                      // Gerar imagens para cada diálogo
                      const dialogosComImagens = await Promise.all(
                        movieData.dialogos.map(async dialogo => {
                          try {
                            const imgResult = await websim.imageGen({
                              prompt: `Cena de filme estilo Frutiger Aero: ${dialogo.cena}`,
                              aspect_ratio: "16:9"
                            });
                            return {...dialogo, imagem: imgResult.url};
                          } catch (error) {
                            console.error('Erro ao gerar imagem:', error);
                            return dialogo;
                          }
                        })
                      );

                      room.collection('ai_movie').create({
                        ...movieData,
                        dialogos: dialogosComImagens,
                        userPrompt: prompt,
                        createdAt: new Date().toISOString()
                      });

                    } catch (error) {
                      console.error('Erro na geração:', error);
                      alert('Erro ao gerar filme! Verifique o console.');
                    }
                  }}>
                    <input
                      type="text"
                      name="moviePrompt"
                      placeholder="Descreva sua ideia (ex: 'um robô que aprende a amar em Marte')"
                      style={{width: '100%', marginBottom: '10px'}}
                    />
                    <button 
                      type="submit" 
                      className="frutiger-button"
                      style={{margin: '10px 0'}}
                    >
                      <img src="/517.png" alt="AI Icon" />
                      Gerar Filme
                    </button>
                  </form>
                </div>

                <h3>Biblioteca de Filmes ({aiMovies.length})</h3>
                <div style={{
                  display: 'grid',
                  gridTemplateColumns: 'repeat(auto-fill, minmax(250px, 1fr))',
                  gap: '20px',
                  marginTop: '20px'
                }}>
                  {aiMovies.map(movie => (
                    <div key={movie.id} className="post" style={{padding: '15px', overflow: 'hidden'}}>
                      <div className="movie-slideshow" 
                        style={{
                          position: 'relative',
                          height: '400px',
                          borderRadius: '16px',
                          overflow: 'hidden',
                          background: 'linear-gradient(145deg, #00c8ff22, #0099cc33)'
                        }}>
                          {(movie.dialogos || []).map((dialogo, idx) => (
                            <div key={idx} className="movie-scene" 
                              style={{
                                position: 'absolute',
                                width: '100%',
                                height: '100%',
                                opacity: 0,
                                animation: `movieFrames ${(movie.dialogos?.length || 1) * 5}s infinite`,
                                animationDelay: `${idx * 5}s`,
                                padding: '20px',
                                background: `linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.7)), url(${dialogo?.imagem || '/images (10).jpeg'})`,
                                backgroundSize: 'cover',
                                backgroundPosition: 'center',
                                color: 'white',
                                display: 'flex',
                                flexDirection: 'column',
                                justifyContent: 'center',
                                alignItems: 'center',
                                textAlign: 'center'
                              }}>
                              <div style={{
                                maxWidth: '600px',
                                background: 'rgba(0, 200, 255, 0.3)',
                                padding: '20px',
                                borderRadius: '16px',
                                border: '2px solid #00c8ff'
                              }}>
                                <h3 style={{margin: '0 0 10px 0', color: '#00fffc'}}>
                                  {dialogo?.personagem || 'Personagem'}
                                </h3>
                                <p style={{
                                  fontSize: '1.2em',
                                  lineHeight: '1.5',
                                  textShadow: '0 0 10px rgba(0, 200, 255, 0.9)'
                                }}>
                                  "{dialogo?.texto || 'Diálogo indisponível'}"
                                </p>
                                <div style={{
                                  marginTop: '10px',
                                  fontSize: '2em',
                                  filter: 'drop-shadow(0 0 5px #00fffc)'
                                }}>
                                  {movie.emojis || '🎬'}
                                </div>
                              </div>
                            </div>
                          ))}
                      </div>
                    </div>
                  ))}
                </div>
              </div>
            )}
          </div>
        );
      }

      ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
  </div>
  <script>
    window.addEventListener('scroll', () => {
      const scrolled = window.scrollY;
      const parallaxBg = document.querySelector('.parallax-background');
      parallaxBg.style.transform = `translateZ(-1px) scale(2) translateY(${scrolled * 0.5}px)`;
    });
  </script>
  <script>
    document.querySelectorAll('.post').forEach(post => {
      post.addEventListener('mousemove', (e) => {
        const rect = post.getBoundingClientRect();
        post.style.setProperty('--x', `${e.clientX - rect.left}px`);
        post.style.setProperty('--y', `${e.clientY - rect.top}px`);
      });
    });
  </script>
</body>
</html>